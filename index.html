<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MIDI → Game JSON Converter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>

<style>
body{
  margin:0;
  background:#0b0f1a;
  color:#e6ebff;
  font-family:Inter,system-ui,Arial;
}
main{
  max-width:1100px;
  margin:auto;
  padding:16px;
}
h1{
  margin:0 0 12px;
}
.panel{
  background:#0f1426;
  border-radius:16px;
  padding:16px;
}
.controls{
  display:grid;
  grid-template-columns:1fr auto auto auto auto;
  gap:10px;
}
input,button{
  padding:10px;
  border-radius:10px;
  border:none;
}
input{
  background:#161c36;
  color:white;
}
button{
  background:linear-gradient(135deg,#6cf2c2,#6ca8ff);
  font-weight:600;
  cursor:pointer;
}
button.secondary{
  background:#1a2142;
  color:white;
}
pre{
  margin-top:12px;
  max-height:65vh;
  overflow:auto;
  border-radius:12px;
  font-size:12px;
}
</style>
</head>

<body>
<main>
<h1>MIDI → Game JSON</h1>

<div class="panel">
  <div class="controls">
    <input id="file" type="file" accept=".mid,.midi">
    <button id="copy">Copy</button>
    <button id="download">Download</button>
    <button id="raw" class="secondary">Raw MIDI</button>
    <button id="clear" class="secondary">Clear</button>
  </div>

  <pre tabindex="0"><code id="output" class="language-json">// Upload a MIDI file</code></pre>
</div>
</main>

<script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>

<script>
const fileInput = document.getElementById("file");
const output = document.getElementById("output");
const copyBtn = document.getElementById("copy");
const downloadBtn = document.getElementById("download");
const clearBtn = document.getElementById("clear");
const rawBtn = document.getElementById("raw");

let rawJSON = "";
let gameJSON = "";
let showingRaw = false;

function buildGameJSON(midi){
  const notes = [];
  midi.tracks.forEach(track=>{
    track.notes.forEach(n=>{
      notes.push({
        note: n.name,
        time: +n.time.toFixed(3),
        length: +n.duration.toFixed(3),
        velocity: +n.velocity.toFixed(3)
      });
    });
  });
  notes.sort((a,b)=>a.time-b.time);
  return notes;
}

fileInput.addEventListener("change", async ()=>{
  const file = fileInput.files[0];
  if(!file) return;

  const buffer = await file.arrayBuffer();
  const midi = new Midi(buffer);

  rawJSON = JSON.stringify(midi.toJSON(), null, 2);
  gameJSON = JSON.stringify(buildGameJSON(midi), null, 2);

  showingRaw = false;
  output.textContent = gameJSON;
  Prism.highlightElement(output);
});

rawBtn.onclick = ()=>{
  if(!rawJSON) return;
  showingRaw = !showingRaw;
  output.textContent = showingRaw ? rawJSON : gameJSON;
  rawBtn.textContent = showingRaw ? "Game JSON" : "Raw MIDI";
  Prism.highlightElement(output);
};

copyBtn.onclick = ()=>{
  const data = showingRaw ? rawJSON : gameJSON;
  if(!data) return;
  navigator.clipboard.writeText(data);
};

downloadBtn.onclick = ()=>{
  const data = showingRaw ? rawJSON : gameJSON;
  if(!data) return;
  const blob = new Blob([data], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = showingRaw ? "midi_raw.json" : "game_music.json";
  a.click();
};

clearBtn.onclick = ()=>{
  rawJSON="";
  gameJSON="";
  output.textContent="// Upload a MIDI file";
};

output.addEventListener("keydown", e=>{
  if((e.ctrlKey||e.metaKey)&&e.key==="a"){
    e.preventDefault();
    const r=document.createRange();
    r.selectNodeContents(output);
    const s=window.getSelection();
    s.removeAllRanges();
    s.addRange(r);
  }
});
</script>
</body>
</html>
